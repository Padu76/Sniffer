<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sniffer Analytics - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #059669;
      --secondary: #10b981;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 2rem 0;
      text-align: center;
      position: relative;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .dashboard-header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .dashboard-header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .version-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      margin-top: 10px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .dashboard-content {
      padding: 2rem 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
      transition: transform 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .chart-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .data-table {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .table-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      font-weight: 600;
    }

    .table-content {
      max-height: 400px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--bg-primary);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    td {
      font-size: 0.9rem;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-success {
      background: #dcfce7;
      color: #166534;
    }

    .status-failure {
      background: #fef2f2;
      color: #dc2626;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid #fecaca;
      margin: 1rem 0;
    }

    .refresh-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      margin-bottom: 2rem;
    }

    .refresh-btn:hover {
      background: var(--secondary);
    }

    .filters {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .filters h3 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .filter-group select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
    }

    .database-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 2rem;
      text-align: center;
    }

    .database-info h4 {
      margin-bottom: 0.5rem;
    }

    .database-info p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .no-data-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .container {
        padding: 0 0.5rem;
      }

      .back-btn {
        position: relative;
        top: auto;
        left: auto;
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="dashboard-header">
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Indietro</button>
    <div class="container">
      <h1>Sniffer Analytics</h1>
      <p>Dashboard Machine Learning e Statistiche Neon PostgreSQL</p>
      <div class="version-badge">v2.0 - Database Neon</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-content">
    <div class="container">
      
      <!-- Database Info -->
      <div class="database-info">
        <h4>Sistema Database Neon PostgreSQL</h4>
        <p>Dati in tempo reale da sensori IoT, feedback utenti e analytics ML</p>
      </div>

      <!-- Refresh Button -->
      <button class="refresh-btn" onclick="loadDashboardData()">
        üîÑ Aggiorna Dati
      </button>

      <!-- Filters -->
      <div class="filters">
        <h3>üîç Filtri</h3>
        <div class="filter-grid">
          <div class="filter-group">
            <label for="targetFilter">Target</label>
            <select id="targetFilter" onchange="applyFilters()">
              <option value="">Tutti</option>
              <option value="funghi">üçÑ Funghi</option>
              <option value="tartufi">‚ö´ Tartufi</option>
              <option value="erbe">üåø Erbe</option>
              <option value="caffe">‚òï Caff√®</option>
              <option value="limone">üçã Limone</option>
              <option value="alcool">üß™ Alcool</option>
              <option value="aceto">ü•ó Aceto</option>
              <option value="vaniglia">‚≠ê Vaniglia</option>
              <option value="custom">‚öôÔ∏è Custom</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="seasonFilter">Stagione</label>
            <select id="seasonFilter" onchange="applyFilters()">
              <option value="">Tutte</option>
              <option value="Primavera">Primavera</option>
              <option value="Estate">Estate</option>
              <option value="Autunno">Autunno</option>
              <option value="Inverno">Inverno</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="weatherFilter">Meteo</label>
            <select id="weatherFilter" onchange="applyFilters()">
              <option value="">Tutti</option>
              <option value="Rainy">Piovoso</option>
              <option value="Cloudy">Nuvoloso</option>
              <option value="Sunny">Soleggiato</option>
              <option value="Foggy">Nebbioso</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value" id="totalScans">-</div>
          <div class="stat-label">Rilevamenti Totali</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-value" id="overallAccuracy">-</div>
          <div class="stat-label">Accuracy Globale</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-value" id="successRate">-</div>
          <div class="stat-label">Tasso Successo</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üìç</div>
          <div class="stat-value" id="uniqueZones">-</div>
          <div class="stat-label">Zone Esplorate</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">üìà Successi per Target</div>
          <div class="chart-container">
            <canvas id="targetChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-title">üå¶Ô∏è Performance per Meteo</div>
          <div class="chart-container">
            <canvas id="weatherChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-title">üèîÔ∏è Distribuzione Altitudine</div>
          <div class="chart-container">
            <canvas id="elevationChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-title">üìÖ Attivit√† nel Tempo</div>
          <div class="chart-container">
            <canvas id="timeChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Recent Feedback Table -->
      <div class="data-table">
        <div class="table-header">
          üìã Rilevamenti Recenti
        </div>
        <div class="table-content">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Target</th>
                <th>Posizione</th>
                <th>Predetto</th>
                <th>Trovato</th>
                <th>Accuracy</th>
              </tr>
            </thead>
            <tbody id="feedbackTable">
              <tr>
                <td colspan="6" class="loading">Caricamento dati...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Dynamic API Configuration
    const API_CONFIG = {
      BASE_URL: window.location.origin,
      ENDPOINTS: {
        feedback: '/api/dashboard?type=feedback',
        scansioni: '/api/dashboard?type=scansioni',
        analytics: '/api/dashboard?type=analytics'
      }
    };

    // Global variables
    let allFeedbackData = [];
    let allScanData = [];
    let filteredData = [];
    let charts = {};

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof Chart !== 'undefined') {
        loadDashboardData();
      } else {
        setTimeout(() => {
          if (typeof Chart !== 'undefined') {
            loadDashboardData();
          } else {
            showError('Errore nel caricamento Chart.js. Ricaricare la pagina.');
          }
        }, 1000);
      }
    });

    // Load all dashboard data
    async function loadDashboardData() {
      try {
        console.log('Loading dashboard data...');
        showLoadingState();
        
        await Promise.all([
          loadFeedbackData(),
          loadScanData(),
          loadAnalytics()
        ]);
        
        applyFilters();
        updateCharts();
        updateTable();
        
        console.log('Dashboard data loaded successfully');
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Errore nel caricamento dei dati: ' + error.message);
        
        // Use mock data as fallback
        allFeedbackData = generateMockData();
        applyFilters();
        updateStats();
        updateCharts();
        updateTable();
      }
    }

    // Load feedback data from Neon
    async function loadFeedbackData() {
      try {
        const response = await fetch(API_CONFIG.ENDPOINTS.feedback);
        if (!response.ok) throw new Error('Failed to fetch feedback data');
        
        const data = await response.json();
        
        // Handle both direct array and nested records structure
        if (Array.isArray(data)) {
          allFeedbackData = data;
        } else if (data.records) {
          allFeedbackData = data.records;
        } else {
          allFeedbackData = [];
        }
        
        console.log('Loaded feedback data:', allFeedbackData.length, 'records');
        
      } catch (error) {
        console.error('Error loading feedback data:', error);
        allFeedbackData = [];
      }
    }

    // Load scan data from Neon
    async function loadScanData() {
      try {
        const response = await fetch(API_CONFIG.ENDPOINTS.scansioni);
        if (!response.ok) throw new Error('Failed to fetch scan data');
        
        const data = await response.json();
        
        if (Array.isArray(data)) {
          allScanData = data;
        } else if (data.records) {
          allScanData = data.records;
        } else {
          allScanData = [];
        }
        
        console.log('Loaded scan data:', allScanData.length, 'records');
        
      } catch (error) {
        console.error('Error loading scan data:', error);
        allScanData = [];
      }
    }

    // Load analytics data from Neon
    async function loadAnalytics() {
      try {
        const response = await fetch(API_CONFIG.ENDPOINTS.analytics);
        if (!response.ok) throw new Error('Failed to fetch analytics');
        
        const data = await response.json();
        
        if (data.analytics) {
          updateStats(data.analytics.summary);
        }
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        updateStats(); // Use default calculation
      }
    }

    // Apply filters
    function applyFilters() {
      const targetFilter = document.getElementById('targetFilter').value;
      const seasonFilter = document.getElementById('seasonFilter').value;
      const weatherFilter = document.getElementById('weatherFilter').value;
      
      // Combine feedback and scan data
      const combinedData = [
        ...allFeedbackData.map(r => ({ ...r, type: 'feedback' })),
        ...allScanData.map(r => ({ ...r, type: 'scan' }))
      ];
      
      filteredData = combinedData.filter(record => {
        const fields = record.fields || record;
        
        // Handle different target field names
        const recordTarget = fields.Search_Target || fields.target || fields.Target;
        if (targetFilter && recordTarget !== targetFilter) return false;
        
        if (seasonFilter && fields.season !== seasonFilter && fields.Season !== seasonFilter) return false;
        if (weatherFilter && fields.weather_category !== weatherFilter && fields.Weather_Category !== weatherFilter) return false;
        
        return true;
      });
      
      console.log('Applied filters:', {
        targetFilter,
        seasonFilter,
        weatherFilter,
        resultCount: filteredData.length
      });
      
      if (!filteredData.length && (allFeedbackData.length || allScanData.length)) {
        // If filters result in no data but we have data, use all data
        filteredData = combinedData;
      }
      
      updateStats();
    }

    // Update statistics
    function updateStats(analyticsData = null) {
      if (analyticsData) {
        document.getElementById('totalScans').textContent = analyticsData.totalScans || analyticsData.totalFeedback || 0;
        document.getElementById('overallAccuracy').textContent = (analyticsData.overallAccuracy || 0) + '%';
        document.getElementById('successRate').textContent = (analyticsData.successRate || 0) + '%';
        document.getElementById('uniqueZones').textContent = analyticsData.totalZones || 0;
        return;
      }

      // Fallback calculation
      const data = filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData];
      
      document.getElementById('totalScans').textContent = data.length;
      
      const accurateCount = data.filter(record => {
        const fields = record.fields || record;
        return fields.accuracy === 100 || fields.Accuracy === 100;
      }).length;
      const accuracy = data.length > 0 ? Math.round((accurateCount / data.length) * 100) : 0;
      document.getElementById('overallAccuracy').textContent = accuracy + '%';
      
      const foundCount = data.filter(record => {
        const fields = record.fields || record;
        return fields.found_mushrooms === true || fields.Found_Mushrooms === true;
      }).length;
      const successRate = data.length > 0 ? Math.round((foundCount / data.length) * 100) : 0;
      document.getElementById('successRate').textContent = successRate + '%';
      
      const uniqueZones = new Set(data.map(record => {
        const fields = record.fields || record;
        return fields.zone_hash || fields.Zone_Hash;
      })).size;
      document.getElementById('uniqueZones').textContent = uniqueZones;
    }

    // Update charts
    function updateCharts() {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        return;
      }

      updateTargetChart();
      updateWeatherChart();
      updateElevationChart();
      updateTimeChart();
    }

    // Target chart
    function updateTargetChart() {
      const ctx = document.getElementById('targetChart');
      if (!ctx) return;
      
      if (charts.target) charts.target.destroy();
      
      const data = filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData];
      const targetData = groupByTarget(data);
      
      const labels = Object.keys(targetData);
      const values = Object.values(targetData).map(records => {
        return records.filter(r => {
          const fields = r.fields || r;
          return fields.found_mushrooms === true || fields.Found_Mushrooms === true;
        }).length;
      });

      if (labels.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        return;
      }
      
      charts.target = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(getTargetDisplayName),
          datasets: [{
            data: values,
            backgroundColor: ['#059669', '#8b4513', '#22c55e', '#6366f1', '#f59e0b', '#ef4444'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Weather chart
    function updateWeatherChart() {
      const ctx = document.getElementById('weatherChart');
      if (!ctx) return;
      
      if (charts.weather) charts.weather.destroy();
      
      const data = filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData];
      const weatherData = groupByWeather(data);
      
      const labels = Object.keys(weatherData);
      const values = Object.values(weatherData).map(records => {
        return records.filter(r => {
          const fields = r.fields || r;
          return fields.found_mushrooms === true || fields.Found_Mushrooms === true;
        }).length;
      });

      if (labels.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        return;
      }
      
      charts.weather = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Successi',
            data: values,
            backgroundColor: '#059669',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Elevation chart
    function updateElevationChart() {
      const ctx = document.getElementById('elevationChart');
      if (!ctx) return;
      
      if (charts.elevation) charts.elevation.destroy();
      
      const data = filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData];
      const elevationData = groupByElevation(data);
      
      charts.elevation = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(elevationData),
          datasets: [{
            label: 'Rilevamenti',
            data: Object.values(elevationData).map(records => records.length),
            backgroundColor: '#10b981',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Time chart
    function updateTimeChart() {
      const ctx = document.getElementById('timeChart');
      if (!ctx) return;
      
      if (charts.time) charts.time.destroy();
      
      const data = filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData];
      const timeData = groupByDate(data);
      
      charts.time = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(timeData).slice(-7), // Last 7 days
          datasets: [{
            label: 'Rilevamenti',
            data: Object.values(timeData).slice(-7).map(records => records.length),
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Update table
    function updateTable() {
      const tbody = document.getElementById('feedbackTable');
      const data = (filteredData.length > 0 ? filteredData : [...allFeedbackData, ...allScanData])
        .slice(0, 20)
        .reverse();
      
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="no-data">
              <div class="no-data-icon">üìä</div>
              <div>Nessun dato disponibile</div>
              <div style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                I dati verranno visualizzati dopo il primo utilizzo del sistema
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map(record => {
        const fields = record.fields || record;
        const date = new Date(fields.timestamp || fields.Timestamp || Date.now()).toLocaleDateString('it-IT');
        const target = getTargetIcon(fields.target || fields.Target || fields.Search_Target || 'funghi');
        const lat = parseFloat(fields.latitude || fields.Latitudine || 0);
        const lon = parseFloat(fields.longitude || fields.Longitudine || 0);
        const location = lat && lon ? `${lat.toFixed(4)}, ${lon.toFixed(4)}` : 'N/A';
        const predicted = (fields.predicted_probability || fields.Predicted_Probability || 0) + '%';
        const found = fields.found_mushrooms || fields.Found_Mushrooms || false;
        const accuracy = fields.accuracy || fields.Accuracy || 0;
        
        return `
          <tr>
            <td>${date}</td>
            <td>${target}</td>
            <td>${location}</td>
            <td>${predicted}</td>
            <td><span class="status-badge ${found ? 'status-success' : 'status-failure'}">${found ? 'S√¨' : 'No'}</span></td>
            <td>${accuracy}%</td>
          </tr>
        `;
      }).join('');
    }

    // Helper functions
    function groupByTarget(data) {
      return data.reduce((groups, record) => {
        const fields = record.fields || record;
        const target = fields.target || fields.Target || fields.Search_Target || 'funghi';
        if (!groups[target]) groups[target] = [];
        groups[target].push(record);
        return groups;
      }, {});
    }

    function groupByWeather(data) {
      return data.reduce((groups, record) => {
        const fields = record.fields || record;
        const weather = fields.weather_category || fields.Weather_Category || 'Other';
        if (!groups[weather]) groups[weather] = [];
        groups[weather].push(record);
        return groups;
      }, {});
    }

    function groupByElevation(data) {
      return data.reduce((groups, record) => {
        const fields = record.fields || record;
        const elevation = fields.elevation || fields.Altitudine || 0;
        let range;
        if (elevation < 200) range = '0-200m';
        else if (elevation < 800) range = '200-800m';
        else if (elevation < 1500) range = '800-1500m';
        else range = '1500m+';
        
        if (!groups[range]) groups[range] = [];
        groups[range].push(record);
        return groups;
      }, {});
    }

    function groupByDate(data) {
      return data.reduce((groups, record) => {
        const fields = record.fields || record;
        const date = new Date(fields.timestamp || fields.Timestamp || Date.now()).toLocaleDateString('it-IT');
        if (!groups[date]) groups[date] = [];
        groups[date].push(record);
        return groups;
      }, {});
    }

    function getTargetIcon(target) {
      const icons = {
        funghi: 'üçÑ Funghi',
        tartufi: '‚ö´ Tartufi',
        erbe: 'üåø Erbe',
        caffe: '‚òï Caff√®',
        limone: 'üçã Limone',
        alcool: 'üß™ Alcool',
        aceto: 'ü•ó Aceto',
        vaniglia: '‚≠ê Vaniglia',
        custom: '‚öôÔ∏è Custom'
      };
      return icons[target] || 'üçÑ Funghi';
    }

    function getTargetDisplayName(target) {
      return getTargetIcon(target).split(' ')[1] || target;
    }

    function showLoadingState() {
      document.getElementById('totalScans').textContent = '-';
      document.getElementById('overallAccuracy').textContent = '-';
      document.getElementById('successRate').textContent = '-';
      document.getElementById('uniqueZones').textContent = '-';
    }

    function showError(message) {
      const container = document.querySelector('.container');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      container.insertBefore(errorDiv, container.firstChild);
    }

    // Mock data generator
    function generateMockData() {
      const targets = ['funghi', 'tartufi', 'erbe', 'caffe', 'limone', 'alcool', 'aceto', 'vaniglia'];
      const weatherTypes = ['Rainy', 'Cloudy', 'Sunny', 'Foggy'];
      const seasons = ['Primavera', 'Estate', 'Autunno', 'Inverno'];
      const mockData = [];
      
      for (let i = 0; i < 30; i++) {
        const target = targets[Math.floor(Math.random() * targets.length)];
        const found = Math.random() > 0.6;
        const predicted = Math.round(Math.random() * 100);
        const accuracy = (found && predicted > 50) || (!found && predicted <= 50) ? 100 : 0;
        
        mockData.push({
          fields: {
            scan_id: `mock_${i}`,
            target: target,
            found_mushrooms: found,
            predicted_probability: predicted,
            latitude: 45.4 + (Math.random() - 0.5) * 0.1,
            longitude: 10.9 + (Math.random() - 0.5) * 0.1,
            elevation: Math.round(Math.random() * 1500),
            accuracy: accuracy,
            zone_hash: `45.${Math.floor(Math.random() * 500)},10.${Math.floor(Math.random() * 1000)}`,
            season: seasons[Math.floor(Math.random() * seasons.length)],
            weather_category: weatherTypes[Math.floor(Math.random() * weatherTypes.length)],
            timestamp: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
          }
        });
      }
      
      return mockData;
    }
  </script>
</body>
</html>