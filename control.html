<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlli Avanzati - Sniffer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html" style="font-weight: bold;">
                <i class="bi bi-arrow-left"></i> üêï‚Äçü¶∫ Sniffer 
                <small class="badge bg-success ms-2">v2.0 Neon</small>
            </a>
            
            <!-- ESP32 Status Indicator -->
            <div class="navbar-nav ms-auto">
                <div id="esp32Status" class="nav-item d-flex align-items-center">
                    <span id="esp32Indicator" class="badge bg-danger me-2">
                        <i class="bi bi-cpu"></i> ESP32 Offline
                    </span>
                </div>
                <a class="nav-link" href="dashboard.html">
                    <i class="bi bi-bar-chart-fill"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5">üéõÔ∏è Controlli Avanzati</h1>
                <p class="lead text-muted">Sistema completo ESP32 + AI Training</p>
            </div>
        </div>

        <!-- ESP32 Advanced Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cpu-fill"></i> ESP32 Hardware Control Center
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Connection Status Row -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h6 class="text-muted">üîå Stato Connessione</h6>
                                <div id="connectionStatus" class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> ESP32 non connesso
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted">‚ö° Azioni</h6>
                                <div class="d-grid gap-2">
                                    <button id="connectESP32" class="btn btn-outline-primary">
                                        <i class="bi bi-wifi"></i> Connetti ESP32
                                    </button>
                                    <button id="refreshConnection" class="btn btn-outline-secondary" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Sensor Dashboard -->
                        <div id="sensorDashboard" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">üìä Dashboard Sensore BME688 - Real Time</h6>
                                <div class="row">
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);">
                                            <div class="card-body text-center">
                                                <i class="bi bi-thermometer-half display-6 mb-2"></i>
                                                <h3 id="tempValue" class="mb-0">--¬∞C</h3>
                                                <small>Temperatura</small>
                                                <div id="tempTrend" class="mt-1">
                                                    <small>--</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #4834d4, #6c5ce7);">
                                            <div class="card-body text-center">
                                                <i class="bi bi-droplet-half display-6 mb-2"></i>
                                                <h3 id="humidityValue" class="mb-0">--%</h3>
                                                <small>Umidit√†</small>
                                                <div id="humidityTrend" class="mt-1">
                                                    <small>--</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #00d2d3, #01a3a4);">
                                            <div class="card-body text-center">
                                                <i class="bi bi-cloud-fog display-6 mb-2"></i>
                                                <h3 id="vocValue" class="mb-0">--</h3>
                                                <small>VOC Index</small>
                                                <div id="vocTrend" class="mt-1">
                                                    <small>--</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card bg-gradient text-white" style="background: linear-gradient(45deg, #ffa726, #ff7043);">
                                            <div class="card-body text-center">
                                                <i class="bi bi-speedometer display-6 mb-2"></i>
                                                <h3 id="gasValue" class="mb-0">--Œ©</h3>
                                                <small>Gas Resistance</small>
                                                <div id="gasTrend" class="mt-1">
                                                    <small>--</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Commands Panel -->
                        <div id="advancedCommands" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">üéõÔ∏è Comandi Avanzati ESP32</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="mb-0">üü¢ Controllo Scansione</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <button id="startScanning" class="btn btn-success">
                                                        <i class="bi bi-play-fill"></i> Start Scanning
                                                    </button>
                                                    <button id="stopScanning" class="btn btn-warning">
                                                        <i class="bi bi-pause-fill"></i> Stop Scanning
                                                    </button>
                                                    <button id="pauseResume" class="btn btn-info">
                                                        <i class="bi bi-skip-start-fill"></i> Pause/Resume
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">‚öôÔ∏è Configurazione Sistema</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <button id="calibrateESP32" class="btn btn-info">
                                                        <i class="bi bi-gear-fill"></i> Calibra Sensore
                                                    </button>
                                                    <button id="resetESP32" class="btn btn-danger">
                                                        <i class="bi bi-arrow-clockwise"></i> Reset Hardware
                                                    </button>
                                                    <button id="deepSleep" class="btn btn-secondary">
                                                        <i class="bi bi-power"></i> Deep Sleep (60s)
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ESP32 Configuration Panel -->
                        <div id="configPanel" class="row" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">‚ö° Configurazione ESP32</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">üì° Intervallo Scansione (ms)</label>
                                                <input type="number" id="scanInterval" class="form-control" value="5000" min="1000" max="30000">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">üîç Intervallo Comandi (ms)</label>
                                                <input type="number" id="commandInterval" class="form-control" value="10000" min="5000" max="60000">
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label class="form-label">üéØ Target Attivo</label>
                                                <select id="activeTarget" class="form-select">
                                                    <option value="">Nessun target</option>
                                                    <option value="caffe">‚òï Caff√®</option>
                                                    <option value="limone">üçã Limone</option>
                                                    <option value="alcool">üç∑ Alcool</option>
                                                    <option value="aceto">ü•ó Aceto</option>
                                                    <option value="vaniglia">üç¶ Vaniglia</option>
                                                    <option value="funghi_porcini">üçÑ Funghi Porcini</option>
                                                    <option value="tartufi">üíé Tartufi</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">üìä Modalit√† Debug</label>
                                                <select id="debugMode" class="form-select">
                                                    <option value="normal">Normale</option>
                                                    <option value="verbose">Verbose</option>
                                                    <option value="silent">Silenzioso</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button id="updateConfig" class="btn btn-primary">
                                                <i class="bi bi-upload"></i> Aggiorna Configurazione
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Training Section -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ü§ñ AI Training System</h5>
                    </div>
                    <div class="card-body">
                        <!-- Target Selection for Training -->
                        <div class="mb-3">
                            <h6 class="text-muted">üéØ Seleziona Target per Training</h6>
                            <div class="row" id="trainingTargets">
                                <!-- Professional Targets -->
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="funghi_porcini" id="train_porcini">
                                        <label class="form-check-label" for="train_porcini">
                                            üçÑ Funghi Porcini
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="tartufi" id="train_tartufi">
                                        <label class="form-check-label" for="train_tartufi">
                                            üíé Tartufi
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="cantarelli" id="train_cantarelli">
                                        <label class="form-check-label" for="train_cantarelli">
                                            üåº Cantarelli
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Domestic Targets -->
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="caffe" id="train_caffe">
                                        <label class="form-check-label" for="train_caffe">
                                            ‚òï Caff√®
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="limone" id="train_limone">
                                        <label class="form-check-label" for="train_limone">
                                            üçã Limone
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="trainingTarget" value="alcool" id="train_alcool">
                                        <label class="form-check-label" for="train_alcool">
                                            üç∑ Alcool
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Controls -->
                        <div class="mb-3">
                            <h6 class="text-muted">üèãÔ∏è Controlli Training</h6>
                            <div class="btn-group w-100" role="group">
                                <button id="startTraining" class="btn btn-success" disabled>
                                    <i class="bi bi-play-circle"></i> Inizia Training
                                </button>
                                <button id="stopTraining" class="btn btn-danger" disabled>
                                    <i class="bi bi-stop-circle"></i> Stop Training
                                </button>
                                <button id="saveModel" class="btn btn-info" disabled>
                                    <i class="bi bi-save"></i> Salva Modello
                                </button>
                            </div>
                        </div>

                        <!-- Training Progress -->
                        <div id="trainingProgress" class="mb-3" style="display: none;">
                            <h6 class="text-muted">üìà Progresso Training</h6>
                            <div class="progress mb-2">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Campioni Baseline</small>
                                    <div id="baselineSamples" class="h6">0</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Campioni Positivi</small>
                                    <div id="positiveSamples" class="h6">0</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Accuracy</small>
                                    <div id="accuracyScore" class="h6">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Status -->
                        <div id="trainingStatus" class="alert alert-secondary">
                            <i class="bi bi-info-circle"></i> Seleziona un target per iniziare il training
                        </div>
                    </div>
                </div>
            </div>

            <!-- ESP32 Device Info -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üì± Device Info</h5>
                    </div>
                    <div class="card-body">
                        <div id="deviceInfo">
                            <div class="mb-2">
                                <small class="text-muted">Device ID:</small><br>
                                <code id="deviceId">ESP32_SNIFFER_001</code>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">WiFi RSSI:</small><br>
                                <span id="wifiRssi">-- dBm</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Ultima Scansione:</small><br>
                                <span id="lastScan">--</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Scansioni Totali:</small><br>
                                <span id="totalScans">--</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Status Sistema:</small><br>
                                <span id="systemStatus" class="badge bg-secondary">Offline</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Uptime:</small><br>
                                <span id="uptime">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-3">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">‚ö° Azioni Rapide</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button id="emergency-stop" class="btn btn-danger btn-sm">
                                <i class="bi bi-exclamation-octagon"></i> Emergency Stop
                            </button>
                            <button id="quick-calibrate" class="btn btn-warning btn-sm">
                                <i class="bi bi-lightning"></i> Quick Calibrate
                            </button>
                            <button id="export-data" class="btn btn-info btn-sm">
                                <i class="bi bi-download"></i> Export Data
                            </button>
                            <button id="system-diagnostics" class="btn btn-secondary btn-sm">
                                <i class="bi bi-gear"></i> Diagnostics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back to Main -->
        <div class="row">
            <div class="col-12 text-center">
                <a href="index.html" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-arrow-left"></i> Torna alla Homepage
                </a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>

    <script>
        // ESP32 Control Center JavaScript
        let esp32Connected = false;
        let esp32StatusInterval;
        let sensorDataInterval;
        let trainingInProgress = false;
        let trainingMonitorInterval;
        let currentSessionId = null;
        let selectedTrainingTarget = null;
        let sensorHistory = {
            temperature: [],
            humidity: [],
            voc: [],
            gas: []
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeControlCenter();
            checkESP32Status();
        });

        function initializeControlCenter() {
            // ESP32 Connection
            document.getElementById('connectESP32').addEventListener('click', connectToESP32);
            document.getElementById('refreshConnection').addEventListener('click', refreshESP32Status);

            // ESP32 Commands
            document.getElementById('startScanning').addEventListener('click', () => sendESP32Command('start_scanning'));
            document.getElementById('stopScanning').addEventListener('click', () => sendESP32Command('stop_scanning'));
            document.getElementById('pauseResume').addEventListener('click', () => sendESP32Command('pause_resume'));
            document.getElementById('calibrateESP32').addEventListener('click', () => sendESP32Command('calibrate'));
            document.getElementById('resetESP32').addEventListener('click', () => sendESP32Command('reset'));
            document.getElementById('deepSleep').addEventListener('click', () => sendESP32Command('deep_sleep'));

            // Configuration
            document.getElementById('updateConfig').addEventListener('click', updateESP32Config);

            // AI Training
            document.getElementById('startTraining').addEventListener('click', startAITraining);
            document.getElementById('stopTraining').addEventListener('click', stopAITraining);
            document.getElementById('saveModel').addEventListener('click', saveAIModel);

            // Training target selection
            document.querySelectorAll('input[name="trainingTarget"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedTrainingTarget = this.value;
                    document.getElementById('startTraining').disabled = false;
                    updateTrainingStatus(`Target selezionato: ${this.value}`);
                });
            });

            // Quick Actions
            document.getElementById('emergency-stop').addEventListener('click', emergencyStop);
            document.getElementById('quick-calibrate').addEventListener('click', quickCalibrate);
            document.getElementById('export-data').addEventListener('click', exportSensorData);
            document.getElementById('system-diagnostics').addEventListener('click', runDiagnostics);
        }

        async function connectToESP32() {
            const connectBtn = document.getElementById('connectESP32');
            const statusDiv = document.getElementById('connectionStatus');
            
            connectBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Connessione...';
            connectBtn.disabled = true;

            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();

                if (data.success) {
                    esp32Connected = true;
                    updateConnectionStatus(true, data);
                    startAdvancedMonitoring();
                    
                    connectBtn.innerHTML = '<i class="bi bi-check-circle"></i> Connesso';
                    connectBtn.classList.remove('btn-outline-primary');
                    connectBtn.classList.add('btn-success');
                    
                    // Enable controls
                    document.getElementById('refreshConnection').disabled = false;
                    document.getElementById('sensorDashboard').style.display = 'block';
                    document.getElementById('advancedCommands').style.display = 'block';
                    document.getElementById('configPanel').style.display = 'block';
                    
                } else {
                    throw new Error(data.error || 'Connessione fallita');
                }
            } catch (error) {
                console.error('Errore connessione ESP32:', error);
                updateConnectionStatus(false);
                
                connectBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Errore';
                connectBtn.classList.add('btn-danger');
                
                setTimeout(() => {
                    connectBtn.innerHTML = '<i class="bi bi-wifi"></i> Riprova';
                    connectBtn.classList.remove('btn-danger');
                    connectBtn.classList.add('btn-outline-primary');
                    connectBtn.disabled = false;
                }, 3000);
            }
        }

        async function checkESP32Status() {
            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();
                
                if (data.success && data.device_status.total_scans > 0) {
                    esp32Connected = true;
                    updateConnectionStatus(true, data);
                    startAdvancedMonitoring();
                    
                    // Auto-connect UI
                    const connectBtn = document.getElementById('connectESP32');
                    connectBtn.innerHTML = '<i class="bi bi-check-circle"></i> ESP32 Attivo';
                    connectBtn.classList.remove('btn-outline-primary');
                    connectBtn.classList.add('btn-success');
                    connectBtn.disabled = true;
                    
                    // Show panels
                    document.getElementById('refreshConnection').disabled = false;
                    document.getElementById('sensorDashboard').style.display = 'block';
                    document.getElementById('advancedCommands').style.display = 'block';
                    document.getElementById('configPanel').style.display = 'block';
                }
            } catch (error) {
                console.log('ESP32 non ancora attivo:', error.message);
            }
        }

        function updateConnectionStatus(connected, data = null) {
            const statusDiv = document.getElementById('connectionStatus');
            const indicator = document.getElementById('esp32Indicator');
            
            if (connected) {
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = '<i class="bi bi-check-circle"></i> ESP32 connesso e operativo';
                
                indicator.className = 'badge bg-success me-2';
                indicator.innerHTML = '<i class="bi bi-cpu"></i> ESP32 Online';
                
                if (data && data.device_status) {
                    updateDeviceInfo(data.device_status);
                }
            } else {
                statusDiv.className = 'alert alert-warning';
                statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ESP32 non connesso';
                
                indicator.className = 'badge bg-danger me-2';
                indicator.innerHTML = '<i class="bi bi-cpu"></i> ESP32 Offline';
            }
        }

        function updateDeviceInfo(deviceStatus) {
            document.getElementById('totalScans').textContent = deviceStatus.total_scans || '--';
            document.getElementById('lastScan').textContent = deviceStatus.last_scan ? 
                new Date(deviceStatus.last_scan).toLocaleString('it-IT') : '--';
            
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.textContent = 'Online';
            systemStatus.className = 'badge bg-success';
        }

        function startAdvancedMonitoring() {
            // Clear existing intervals
            if (esp32StatusInterval) clearInterval(esp32StatusInterval);
            if (sensorDataInterval) clearInterval(sensorDataInterval);
            
            // Status check ogni 15 secondi
            esp32StatusInterval = setInterval(refreshESP32Status, 15000);
            
            // Sensor data ogni 3 secondi per controlli avanzati
            sensorDataInterval = setInterval(updateAdvancedSensorData, 3000);
        }

        async function updateAdvancedSensorData() {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch('/api/hardware-data');
                const data = await response.json();
                
                if (data.success && data.recent_data.length > 0) {
                    const latestData = data.recent_data[0];
                    const sensorData = latestData.sensor_data;
                    
                    // Update advanced display with trends
                    updateSensorValueWithTrend('temp', sensorData.temperature, '¬∞C');
                    updateSensorValueWithTrend('humidity', sensorData.humidity, '%');
                    updateSensorValueWithTrend('voc', sensorData.voc_index, '');
                    updateSensorValueWithTrend('gas', sensorData.gas_resistance, 'Œ©');
                    
                    // Store history for trends
                    storeSensorHistory(sensorData);
                }
            } catch (error) {
                console.error('Errore aggiornamento sensori avanzati:', error);
            }
        }

        function updateSensorValueWithTrend(type, value, unit) {
            const valueElement = document.getElementById(`${type}Value`);
            const trendElement = document.getElementById(`${type}Trend`);
            
            if (value !== undefined && value !== null) {
                let displayValue;
                if (type === 'gas') {
                    displayValue = Math.round(value) + unit;
                } else {
                    displayValue = value.toFixed(1) + unit;
                }
                
                valueElement.textContent = displayValue;
                
                // Calculate trend
                const history = sensorHistory[type === 'temp' ? 'temperature' : type];
                if (history.length >= 2) {
                    const current = parseFloat(value);
                    const previous = history[history.length - 2];
                    const trend = current > previous ? '‚ÜóÔ∏è' : current < previous ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
                    const diff = Math.abs(current - previous).toFixed(1);
                    trendElement.innerHTML = `<small>${trend} ${diff}${unit}</small>`;
                }
            } else {
                valueElement.textContent = '--' + unit;
                trendElement.innerHTML = '<small>--</small>';
            }
        }

        function storeSensorHistory(sensorData) {
            // Keep last 10 values for trend calculation
            const maxHistory = 10;
            
            if (sensorData.temperature) {
                sensorHistory.temperature.push(sensorData.temperature);
                if (sensorHistory.temperature.length > maxHistory) {
                    sensorHistory.temperature.shift();
                }
            }
            
            if (sensorData.humidity) {
                sensorHistory.humidity.push(sensorData.humidity);
                if (sensorHistory.humidity.length > maxHistory) {
                    sensorHistory.humidity.shift();
                }
            }
            
            if (sensorData.voc_index) {
                sensorHistory.voc.push(sensorData.voc_index);
                if (sensorHistory.voc.length > maxHistory) {
                    sensorHistory.voc.shift();
                }
            }
            
            if (sensorData.gas_resistance) {
                sensorHistory.gas.push(sensorData.gas_resistance);
                if (sensorHistory.gas.length > maxHistory) {
                    sensorHistory.gas.shift();
                }
            }
        }

        async function sendESP32Command(command) {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch(`/api/hardware-data?device_id=ESP32_SNIFFER_001&action=command&cmd=${command}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`Comando ${command} inviato con successo`);
                    showCommandFeedback(command);
                } else {
                    console.error('Errore invio comando:', data.error);
                }
            } catch (error) {
                console.error('Errore comando ESP32:', error);
            }
        }

        function showCommandFeedback(command) {
            // Visual feedback per comando inviato
            const statusDiv = document.getElementById('connectionStatus');
            const originalContent = statusDiv.innerHTML;
            const originalClass = statusDiv.className;
            
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = `<i class="bi bi-check"></i> Comando '${command}' inviato con successo`;
            
            setTimeout(() => {
                statusDiv.className = originalClass;
                statusDiv.innerHTML = originalContent;
            }, 3000);
        }

        async function updateESP32Config() {
            const config = {
                scan_interval: document.getElementById('scanInterval').value,
                command_interval: document.getElementById('commandInterval').value,
                active_target: document.getElementById('activeTarget').value,
                debug_mode: document.getElementById('debugMode').value
            };

            try {
                const response = await fetch('/api/hardware-data', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: 'ESP32_SNIFFER_001',
                        config: config
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showCommandFeedback('configurazione aggiornata');
                }
            } catch (error) {
                console.error('Errore aggiornamento config:', error);
            }
        }

        async function refreshESP32Status() {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();
                
                if (data.success) {
                    updateConnectionStatus(true, data);
                } else {
                    updateConnectionStatus(false);
                    esp32Connected = false;
                }
            } catch (error) {
                console.error('Errore refresh status:', error);
                updateConnectionStatus(false);
                esp32Connected = false;
            }
        }

        // AI Training Functions
        async function startAITraining() {
            if (!selectedTrainingTarget) {
                updateTrainingStatus('Seleziona prima un target');
                return;
            }
            
            trainingInProgress = true;
            updateTrainingUI(true);
            updateTrainingStatus('Avvio training in corso...');
            
            try {
                const response = await fetch('/api/start-training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: 'ESP32_SNIFFER_001',
                        target_type: selectedTrainingTarget,
                        training_name: `Training_${selectedTrainingTarget}_${Date.now()}`
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentSessionId = data.session_id;
                    updateTrainingStatus('Training avviato con successo');
                    startTrainingMonitoring();
                } else {
                    throw new Error(data.error || 'Errore avvio training');
                }
            } catch (error) {
                console.error('Errore avvio training:', error);
                updateTrainingStatus('Errore nell\'avvio del training: ' + error.message);
                trainingInProgress = false;
                updateTrainingUI(false);
            }
        }

        async function stopAITraining() {
            if (!trainingInProgress || !currentSessionId) {
                updateTrainingStatus('Nessun training attivo da fermare');
                return;
            }

            try {
                const response = await fetch('/api/stop-training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        device_id: 'ESP32_SNIFFER_001'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    trainingInProgress = false;
                    currentSessionId = null;
                    updateTrainingUI(false);
                    updateTrainingStatus('Training fermato con successo');
                    stopTrainingMonitoring();
                } else {
                    throw new Error(data.error || 'Errore stop training');
                }
            } catch (error) {
                console.error('Errore stop training:', error);
                updateTrainingStatus('Errore nel fermare il training: ' + error.message);
            }
        }

        async function saveAIModel() {
            if (!currentSessionId) {
                updateTrainingStatus('Nessuna sessione di training attiva');
                return;
            }

            try {
                updateTrainingStatus('Salvataggio modello in corso...');
                
                const response = await fetch('/api/save-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        device_id: 'ESP32_SNIFFER_001',
                        model_name: `Model_${selectedTrainingTarget}_${Date.now()}`
                    })
                });

                const data = await response.json();
                if (data.success) {
                    updateTrainingStatus('Modello salvato con successo!');
                    // Reset training state
                    trainingInProgress = false;
                    currentSessionId = null;
                    updateTrainingUI(false);
                } else {
                    throw new Error(data.error || 'Errore salvataggio modello');
                }
            } catch (error) {
                console.error('Errore salvataggio modello:', error);
                updateTrainingStatus('Errore nel salvataggio: ' + error.message);
            }
        }

        function startTrainingMonitoring() {
            // Clear existing interval
            if (trainingMonitorInterval) {
                clearInterval(trainingMonitorInterval);
            }
            
            // Monitor training progress every 5 seconds
            trainingMonitorInterval = setInterval(async () => {
                if (!trainingInProgress || !currentSessionId) {
                    clearInterval(trainingMonitorInterval);
                    return;
                }
                
                try {
                    const response = await fetch(`/api/training-status?session_id=${currentSessionId}`);
                    const data = await response.json();
                    
                    if (data.success && data.training_data) {
                        updateTrainingProgress(data.training_data);
                    }
                } catch (error) {
                    console.error('Errore monitoring training:', error);
                }
            }, 5000);
        }

        function stopTrainingMonitoring() {
            if (trainingMonitorInterval) {
                clearInterval(trainingMonitorInterval);
                trainingMonitorInterval = null;
            }
        }

        function updateTrainingProgress(trainingData) {
            // Update progress bars and counters
            const totalSamples = trainingData.baseline_samples + trainingData.positive_samples + trainingData.negative_samples;
            const targetSamples = 35; // Expected total samples
            const progress = Math.min((totalSamples / targetSamples) * 100, 100);
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
            
            document.getElementById('baselineSamples').textContent = trainingData.baseline_samples || 0;
            document.getElementById('positiveSamples').textContent = trainingData.positive_samples || 0;
            document.getElementById('accuracyScore').textContent = (trainingData.accuracy_score || 0) + '%';
            
            updateTrainingStatus(`Training in corso: ${totalSamples}/${targetSamples} campioni raccolti`);
        }

        function updateTrainingUI(isTraining) {
            document.getElementById('startTraining').disabled = isTraining;
            document.getElementById('stopTraining').disabled = !isTraining;
            document.getElementById('saveModel').disabled = !isTraining;
            
            if (isTraining) {
                document.getElementById('trainingProgress').style.display = 'block';
            } else {
                document.getElementById('trainingProgress').style.display = 'none';
                // Reset progress display
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressText').textContent = '0%';
                document.getElementById('baselineSamples').textContent = '0';
                document.getElementById('positiveSamples').textContent = '0';
                document.getElementById('accuracyScore').textContent = '0%';
            }
        }

        function updateTrainingStatus(message) {
            const statusDiv = document.getElementById('trainingStatus');
            statusDiv.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
        }

        // Quick Actions
        async function emergencyStop() {
            // Stop all operations
            await sendESP32Command('stop_scanning');
            if (trainingInProgress) {
                await stopAITraining();
            }
            updateTrainingStatus('Emergency stop eseguito - Tutti i processi fermati');
        }

        async function quickCalibrate() {
            updateTrainingStatus('Calibrazione rapida in corso...');
            await sendESP32Command('calibrate');
            setTimeout(() => {
                updateTrainingStatus('Calibrazione completata');
            }, 5000);
        }

        function exportSensorData() {
            updateTrainingStatus('Preparazione export dati...');
            
            // Create CSV data from recent sensor readings
            const csvData = [
                'timestamp,temperature,humidity,voc_index,gas_resistance',
                // Add mock data for demo - in real app would fetch from API
                ...Array.from({length: 10}, (_, i) => {
                    const timestamp = new Date(Date.now() - i * 60000).toISOString();
                    const temp = (Math.random() * 5 + 20).toFixed(1);
                    const hum = Math.floor(Math.random() * 20 + 40);
                    const voc = Math.floor(Math.random() * 300 + 50);
                    const gas = Math.floor(Math.random() * 50000 + 100000);
                    return `${timestamp},${temp},${hum},${voc},${gas}`;
                })
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sniffer_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateTrainingStatus('Dati esportati con successo');
        }

        function runDiagnostics() {
            updateTrainingStatus('Esecuzione diagnostica sistema...');
            
            // Mock diagnostics - in real app would check various system components
            setTimeout(() => {
                const diagnostics = [
                    'ESP32: Online ‚úì',
                    'Sensore BME688: Funzionante ‚úì',
                    'Connessione WiFi: Stabile ‚úì',
                    'Database Neon: Connesso ‚úì',
                    'API Endpoints: Operativi ‚úì'
                ];
                
                updateTrainingStatus('Diagnostica completata: ' + diagnostics.join(', '));
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (esp32StatusInterval) clearInterval(esp32StatusInterval);
            if (sensorDataInterval) clearInterval(sensorDataInterval);
            if (trainingMonitorInterval) clearInterval(trainingMonitorInterval);
        });
    </script>
</body>
</html>