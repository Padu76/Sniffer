<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniffer - Rilevatore Intelligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#" style="font-weight: bold;">
                üêï‚Äçü¶∫ Sniffer 
                <small class="badge bg-success ms-2">v2.0 Neon</small>
            </a>
            
            <!-- ESP32 Status Indicator -->
            <div class="navbar-nav ms-auto">
                <div id="esp32Status" class="nav-item d-flex align-items-center">
                    <span id="esp32Indicator" class="badge bg-danger me-2">
                        <i class="bi bi-cpu"></i> ESP32 Offline
                    </span>
                </div>
                <a class="nav-link" href="#" onclick="showAbout()">
                    <i class="bi bi-info-circle"></i> Info
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4">üçÑ Rilevatore Intelligente</h1>
                <p class="lead">Analisi territorio con AI e sensori avanzati</p>
            </div>
        </div>

        <!-- ESP32 Hardware Control Panel -->
        <div class="row mb-4" id="hardwarePanel">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cpu"></i> Controllo Hardware ESP32
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- ESP32 Connection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button id="connectESP32" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-wifi"></i> Connetti Sonda ESP32
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="refreshESP32" class="btn btn-outline-secondary w-100" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Aggiorna Status
                                </button>
                            </div>
                        </div>

                        <!-- Real-time Sensor Data -->
                        <div id="sensorDataPanel" class="row mb-3" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-muted mb-2">üìä Dati Sensore Real-time</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <small class="text-muted">Temperatura</small>
                                                <div id="tempValue" class="h5 mb-0">--¬∞C</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <small class="text-muted">Umidit√†</small>
                                                <div id="humidityValue" class="h5 mb-0">--%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <small class="text-muted">VOC Index</small>
                                                <div id="vocValue" class="h5 mb-0">--</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <small class="text-muted">Gas Resistance</small>
                                                <div id="gasValue" class="h5 mb-0">--Œ©</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ESP32 Remote Commands -->
                        <div id="esp32Commands" class="row" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-muted mb-2">üéõÔ∏è Comandi Remoti</h6>
                                <div class="btn-group w-100" role="group">
                                    <button id="startScanning" class="btn btn-success btn-sm">
                                        <i class="bi bi-play-fill"></i> Start
                                    </button>
                                    <button id="stopScanning" class="btn btn-warning btn-sm">
                                        <i class="bi bi-pause-fill"></i> Stop
                                    </button>
                                    <button id="calibrateESP32" class="btn btn-info btn-sm">
                                        <i class="bi bi-gear-fill"></i> Calibra
                                    </button>
                                    <button id="resetESP32" class="btn btn-danger btn-sm">
                                        <i class="bi bi-arrow-clockwise"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Target Selection Cards -->
        <div class="row mb-4">
            <!-- Professional Targets -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üå≤ Target Professionali</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="professionalTargets">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 target-card" data-target="funghi_porcini">
                                    <div class="card-body text-center">
                                        <i class="bi bi-mushroom display-6 text-success"></i>
                                        <h6 class="card-title mt-2">Funghi Porcini</h6>
                                        <p class="card-text small">Terreno boschivo, umidit√† alta</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 target-card" data-target="tartufi">
                                    <div class="card-body text-center">
                                        <i class="bi bi-gem display-6 text-warning"></i>
                                        <h6 class="card-title mt-2">Tartufi</h6>
                                        <p class="card-text small">Radici alberi, calcio elevato</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 target-card" data-target="funghi_cantarelli">
                                    <div class="card-body text-center">
                                        <i class="bi bi-flower1 display-6 text-info"></i>
                                        <h6 class="card-title mt-2">Cantarelli</h6>
                                        <p class="card-text small">Sottobosco, terreno acido</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Domestic Test Targets -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üè† Test Domestici</h5>
                    </div>
                    <div class="card-body">
                        <div id="domesticTargets">
                            <div class="card mb-2 target-card-domestic" data-target="caffe">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">‚òï</span>
                                        <strong>Caff√®</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2 target-card-domestic" data-target="limone">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">üçã</span>
                                        <strong>Limone</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2 target-card-domestic" data-target="alcool">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">üç∑</span>
                                        <strong>Alcool</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2 target-card-domestic" data-target="aceto">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">ü•ó</span>
                                        <strong>Aceto</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="card target-card-domestic" data-target="vaniglia">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">üç¶</span>
                                        <strong>Vaniglia</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Test Selection Box -->
        <div id="quickTestBox" class="card border-info mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-lightning-charge"></i> Test Rapido - Odori Semplici
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-3">Inizia con odori facilmente riconoscibili per testare il sistema ESP32</p>
                
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 quick-test-card" data-target="caffe" style="cursor: pointer;">
                            <div class="card-body text-center p-3">
                                <div style="font-size: 2rem; margin-bottom: 8px;">‚òï</div>
                                <h6 class="card-title mb-1">Caff√®</h6>
                                <small class="text-muted">Intenso e distintivo</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 quick-test-card" data-target="profumo" style="cursor: pointer;">
                            <div class="card-body text-center p-3">
                                <div style="font-size: 2rem; margin-bottom: 8px;">üå∏</div>
                                <h6 class="card-title mb-1">Profumo</h6>
                                <small class="text-muted">Fragranza floreale</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 quick-test-card" data-target="limone" style="cursor: pointer;">
                            <div class="card-body text-center p-3">
                                <div style="font-size: 2rem; margin-bottom: 8px;">üçã</div>
                                <h6 class="card-title mb-1">Limone</h6>
                                <small class="text-muted">Agrume fresco</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 quick-test-card" data-target="menta" style="cursor: pointer;">
                            <div class="card-body text-center p-3">
                                <div style="font-size: 2rem; margin-bottom: 8px;">üåø</div>
                                <h6 class="card-title mb-1">Menta</h6>
                                <small class="text-muted">Aroma mentolato</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button id="startQuickTest" class="btn btn-info btn-sm" disabled>
                        <i class="bi bi-play-circle"></i> Avvia Test Rapido
                    </button>
                    <small class="text-muted ms-2">Seleziona un odore per iniziare</small>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-grid gap-2">
                    <button id="startAnalysis" class="btn btn-success btn-lg" disabled>
                        <i class="bi bi-play-circle-fill"></i> Inizia Analisi Completa
                    </button>
                    <div class="btn-group mt-2" role="group">
                        <button id="quickScan" class="btn btn-outline-primary">
                            <i class="bi bi-camera-fill"></i> Scan Rapido
                        </button>
                        <button id="gotoControl" class="btn btn-outline-secondary">
                            <i class="bi bi-sliders"></i> Controlli Avanzati
                        </button>
                        <button id="gotoDashboard" class="btn btn-outline-info">
                            <i class="bi bi-bar-chart-fill"></i> Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div id="statusDisplay" class="alert alert-secondary" style="display: none;">
            <div class="d-flex align-items-center">
                <div id="statusSpinner" class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span id="statusText">Preparazione analisi...</span>
            </div>
            <div id="progressBar" class="progress mt-2" style="height: 20px; display: none;">
                <div id="progressFill" class="progress-bar" role="progressbar" style="width: 0%">
                    <span id="progressText">0%</span>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div id="resultsDisplay" class="card" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">üìä Risultati Analisi</h5>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üêï‚Äçü¶∫ Sniffer v2.0</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Rilevatore Intelligente di Odori</strong></p>
                    <ul>
                        <li>‚úÖ Database: Neon PostgreSQL</li>
                        <li>‚úÖ Hardware: ESP32 + BME688</li>
                        <li>‚úÖ AI Vision integrata</li>
                        <li>‚úÖ Target domestici per test</li>
                        <li>‚úÖ Dashboard analytics real-time</li>
                    </ul>
                    <hr>
                    <p><small class="text-muted">
                        <i class="bi bi-github"></i> Repository: /sniffer<br>
                        <i class="bi bi-cloud"></i> Hosting: Vercel<br>
                        <i class="bi bi-database"></i> Database: Neon PostgreSQL
                    </small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>

    <script>
        // ESP32 Integration JavaScript
        let esp32Connected = false;
        let esp32StatusInterval;
        let sensorDataInterval;
        let selectedTarget = null;

        // Initialize ESP32 UI
        document.addEventListener('DOMContentLoaded', function() {
            initializeESP32UI();
        });

        function initializeESP32UI() {
            // ESP32 Connection Button
            document.getElementById('connectESP32').addEventListener('click', connectToESP32);
            document.getElementById('refreshESP32').addEventListener('click', refreshESP32Status);

            // Remote Command Buttons
            document.getElementById('startScanning').addEventListener('click', () => sendESP32Command('start_scanning'));
            document.getElementById('stopScanning').addEventListener('click', () => sendESP32Command('stop_scanning'));
            document.getElementById('calibrateESP32').addEventListener('click', () => sendESP32Command('calibrate'));
            document.getElementById('resetESP32').addEventListener('click', () => sendESP32Command('reset'));

            // Target Selection
            document.querySelectorAll('.target-card, .target-card-domestic').forEach(card => {
                card.addEventListener('click', function() {
                    selectTarget(this.dataset.target);
                });
            });

            // Check ESP32 status on page load
            checkESP32Status();
        }

        async function connectToESP32() {
            const connectBtn = document.getElementById('connectESP32');
            connectBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Connessione...';
            connectBtn.disabled = true;

            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();

                if (data.success) {
                    esp32Connected = true;
                    updateESP32Status(true);
                    startESP32Monitoring();
                    
                    connectBtn.innerHTML = '<i class="bi bi-check-circle"></i> Connesso';
                    connectBtn.classList.remove('btn-outline-primary');
                    connectBtn.classList.add('btn-success');
                    
                    // Enable other controls
                    document.getElementById('refreshESP32').disabled = false;
                    document.getElementById('startAnalysis').disabled = false;
                    
                    // Show sensor panels
                    document.getElementById('sensorDataPanel').style.display = 'block';
                    document.getElementById('esp32Commands').style.display = 'block';
                    
                } else {
                    throw new Error(data.error || 'Connessione fallita');
                }
            } catch (error) {
                console.error('Errore connessione ESP32:', error);
                connectBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Errore Connessione';
                connectBtn.classList.add('btn-danger');
                
                setTimeout(() => {
                    connectBtn.innerHTML = '<i class="bi bi-wifi"></i> Riprova Connessione';
                    connectBtn.classList.remove('btn-danger');
                    connectBtn.classList.add('btn-outline-primary');
                    connectBtn.disabled = false;
                }, 3000);
            }
        }

        async function checkESP32Status() {
            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();
                
                if (data.success && data.device_status.total_scans > 0) {
                    // ESP32 is actively sending data
                    esp32Connected = true;
                    updateESP32Status(true);
                    startESP32Monitoring();
                    
                    // Update UI automatically
                    const connectBtn = document.getElementById('connectESP32');
                    connectBtn.innerHTML = '<i class="bi bi-check-circle"></i> ESP32 Attivo';
                    connectBtn.classList.remove('btn-outline-primary');
                    connectBtn.classList.add('btn-success');
                    connectBtn.disabled = true;
                    
                    document.getElementById('refreshESP32').disabled = false;
                    document.getElementById('startAnalysis').disabled = false;
                    document.getElementById('sensorDataPanel').style.display = 'block';
                    document.getElementById('esp32Commands').style.display = 'block';
                }
            } catch (error) {
                console.log('ESP32 not yet active:', error.message);
            }
        }

        function updateESP32Status(connected) {
            const statusIndicator = document.getElementById('esp32Indicator');
            
            if (connected) {
                statusIndicator.className = 'badge bg-success me-2';
                statusIndicator.innerHTML = '<i class="bi bi-cpu"></i> ESP32 Online';
            } else {
                statusIndicator.className = 'badge bg-danger me-2';
                statusIndicator.innerHTML = '<i class="bi bi-cpu"></i> ESP32 Offline';
            }
        }

        function startESP32Monitoring() {
            // Monitor ESP32 status every 30 seconds
            esp32StatusInterval = setInterval(refreshESP32Status, 30000);
            
            // Get sensor data every 5 seconds
            sensorDataInterval = setInterval(updateSensorData, 5000);
        }

        async function refreshESP32Status() {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch('/api/hardware-data?action=status&device_id=ESP32_SNIFFER_001');
                const data = await response.json();
                
                if (data.success) {
                    updateESP32Status(true);
                } else {
                    updateESP32Status(false);
                    esp32Connected = false;
                }
            } catch (error) {
                console.error('Errore refresh ESP32:', error);
                updateESP32Status(false);
                esp32Connected = false;
            }
        }

        async function updateSensorData() {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch('/api/hardware-data');
                const data = await response.json();
                
                if (data.success && data.recent_data.length > 0) {
                    const latestData = data.recent_data[0];
                    const sensorData = latestData.sensor_data;
                    
                    // Update sensor value displays
                    document.getElementById('tempValue').textContent = 
                        sensorData.temperature ? sensorData.temperature.toFixed(1) + '¬∞C' : '--¬∞C';
                    document.getElementById('humidityValue').textContent = 
                        sensorData.humidity ? sensorData.humidity.toFixed(1) + '%' : '--%';
                    document.getElementById('vocValue').textContent = 
                        sensorData.voc_index ? sensorData.voc_index.toFixed(1) : '--';
                    document.getElementById('gasValue').textContent = 
                        sensorData.gas_resistance ? Math.round(sensorData.gas_resistance) + 'Œ©' : '--Œ©';
                }
            } catch (error) {
                console.error('Errore aggiornamento sensori:', error);
            }
        }

        async function sendESP32Command(command) {
            if (!esp32Connected) return;
            
            try {
                const response = await fetch(`/api/hardware-data?device_id=ESP32_SNIFFER_001&action=command&cmd=${command}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`Comando ${command} inviato con successo`);
                    
                    // Visual feedback
                    const button = document.querySelector(`[onclick*="${command}"]`);
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="bi bi-check"></i> Inviato';
                        button.disabled = true;
                        
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }, 2000);
                    }
                } else {
                    console.error('Errore invio comando:', data.error);
                }
            } catch (error) {
                console.error('Errore comando ESP32:', error);
            }
        }

        function selectTarget(target) {
            selectedTarget = target;
            
            // Remove previous selections
            document.querySelectorAll('.target-card, .target-card-domestic').forEach(card => {
                card.classList.remove('border-success');
                card.style.backgroundColor = '';
            });
            
            // Highlight selected target
            const selectedCard = document.querySelector(`[data-target="${target}"]`);
            selectedCard.classList.add('border-success');
            selectedCard.style.backgroundColor = '#e8f5e8';
            
            console.log('Target selezionato:', target);
        }

        function showAbout() {
            const modal = new bootstrap.Modal(document.getElementById('aboutModal'));
            modal.show();
        }

        // Navigation functions
        document.getElementById('gotoControl').addEventListener('click', () => {
            window.location.href = 'control.html';
        });

        document.getElementById('gotoDashboard').addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        // Cleanup intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (esp32StatusInterval) clearInterval(esp32StatusInterval);
            if (sensorDataInterval) clearInterval(sensorDataInterval);
        });
    </script>
</body>
</html>