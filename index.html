<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>👃 Sniffer - Rilevatore Intelligente Universale</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header con Menu -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <span class="logo-icon">👃</span>
          <h1>Sniffer</h1>
        </div>
        <nav class="nav">
          <a href="/dashboard.html" class="nav-link">
            <span class="nav-icon">📊</span>
            <span>Dashboard</span>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Hero Section Universale -->
  <div class="hero">
    <div class="hero-bg"></div>
    <div class="container">
      <div class="hero-content">
        <div class="hero-main">
          <h2 class="hero-title">Rilevatore Intelligente</h2>
          <p class="hero-subtitle">Trova tesori nascosti con AI, sensori e machine learning avanzato</p>
          
          <!-- Target Selector -->
          <div class="target-selector">
            <label for="searchTarget">🎯 Cosa stai cercando?</label>
            <select id="searchTarget" onchange="updateSearchMode()">
              <option value="funghi">🍄 Funghi</option>
              <option value="tartufi">🟤 Tartufi</option>
              <option value="erbe">🌿 Erbe Medicinali</option>
              <option value="custom">⚙️ Personalizzato</option>
            </select>
          </div>
          
          <!-- Statistiche Live -->
          <div class="hero-stats">
            <div class="stat-item">
              <div class="stat-value" id="heroTotalScans">-</div>
              <div class="stat-label">Rilevamenti</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="heroAccuracy">-</div>
              <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="heroSuccess">-</div>
              <div class="stat-label">Successi</div>
            </div>
          </div>
        </div>
        
        <!-- Dynamic Visual -->
        <div class="hero-visual">
          <div class="target-container">
            <div class="target-icon" id="heroTargetIcon">🍄</div>
            <div class="detection-waves">
              <div class="wave wave-1"></div>
              <div class="wave wave-2"></div>
              <div class="wave wave-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container">
    <div class="container">
      
      <!-- Quick Action Card -->
      <div class="quick-action-card">
        <h3 id="actionTitle">🎯 Inizia la Ricerca</h3>
        <p id="actionDescription">Analizza il terreno e scopri se ci sono tesori nascosti nelle vicinanze</p>
        <div class="action-buttons">
          <button class="action-btn primary" onclick="startQuickScan()">
            <span class="btn-icon">📷</span>
            <span class="btn-text">Scatta e Rileva</span>
          </button>
          <button class="action-btn secondary" onclick="scrollToDetailedScan()">
            <span class="btn-icon">🔍</span>
            <span class="btn-text">Analisi Avanzata</span>
          </button>
        </div>
      </div>

      <!-- Search Mode Info -->
      <div class="search-mode-info" id="searchModeInfo">
        <div class="mode-header">
          <span class="mode-icon" id="modeIcon">🍄</span>
          <div class="mode-content">
            <h4 id="modeTitle">Modalità Funghi</h4>
            <p id="modeDescription">Ricerca funghi commestibili in base a terreno, umidità e vegetazione</p>
          </div>
        </div>
        <div class="mode-tips" id="modeTips">
          <strong>💡 Suggerimenti:</strong> Cerca in zone umide, vicino a querce e castagni, dopo piogge
        </div>
      </div>

      <!-- Status Cards Dinamiche -->
      <div class="status-section">
        <h3>📍 Condizioni Ambientali</h3>
        <div class="status-grid">
          <div class="status-card" id="locationCard">
            <div class="status-header">
              <div class="status-icon">📍</div>
              <div class="status-pulse"></div>
            </div>
            <div class="status-content">
              <span class="status-label">Posizione</span>
              <span class="status-value" id="location">Rilevamento...</span>
            </div>
          </div>
          
          <div class="status-card" id="elevationCard">
            <div class="status-header">
              <div class="status-icon">🏔️</div>
              <div class="status-indicator"></div>
            </div>
            <div class="status-content">
              <span class="status-label">Altitudine</span>
              <span class="status-value" id="elevation">–</span>
            </div>
          </div>
          
          <div class="status-card" id="weatherCard">
            <div class="status-header">
              <div class="status-icon">🌦️</div>
              <div class="status-indicator"></div>
            </div>
            <div class="status-content">
              <span class="status-label">Meteo</span>
              <span class="status-value" id="weather">–</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensor Configuration (Future) -->
      <div class="sensor-section" style="display: none;" id="sensorSection">
        <h3>🔬 Configurazione Sensori</h3>
        <div class="sensor-card">
          <div class="sensor-status">
            <span class="sensor-icon">📡</span>
            <div class="sensor-info">
              <span class="sensor-label">Sonda Olfattiva</span>
              <span class="sensor-value" id="sensorStatus">Non Connessa</span>
            </div>
            <button class="sensor-btn" id="connectSensor">Connetti</button>
          </div>
          <div class="sensor-calibration" id="sensorCalibration" style="display: none;">
            <p>🎯 Calibra la sonda per il target selezionato</p>
            <button class="calibrate-btn" onclick="calibrateSensor()">Calibra Sensore</button>
          </div>
        </div>
      </div>

      <!-- Photo Upload Section -->
      <div class="upload-section">
        <h3>📸 Analisi Visiva del Terreno</h3>
        <div class="upload-area" id="uploadArea">
          <input type="file" id="imageUpload" accept="image/*" capture="environment" hidden>
          <div class="upload-content">
            <div class="upload-visual">
              <div class="upload-icon-large">📷</div>
              <div class="upload-rings">
                <div class="ring ring-1"></div>
                <div class="ring ring-2"></div>
                <div class="ring ring-3"></div>
              </div>
            </div>
            <h4 class="upload-title">Aggiungi Foto del Terreno</h4>
            <p class="upload-text">Scatta una foto per l'analisi AI del territorio</p>
            <p class="upload-hint" id="uploadHint">Inquadra il terreno dove vuoi cercare</p>
            <div class="upload-buttons">
              <button class="upload-btn camera" onclick="takePhoto()">
                <span>📷 Scatta Foto</span>
              </button>
              <button class="upload-btn gallery" onclick="selectPhoto()">
                <span>🖼️ Dalla Galleria</span>
              </button>
            </div>
          </div>
          <div class="image-preview" id="imagePreview" style="display: none;">
            <img id="previewImg" alt="Anteprima">
            <div class="preview-overlay">
              <button class="preview-btn remove" id="removeImage">
                <span>🗑️ Rimuovi</span>
              </button>
              <button class="preview-btn retake" onclick="retakePhoto()">
                <span>🔄 Rifai</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Analyze Button Dinamico -->
      <div class="analyze-section">
        <button class="analyze-btn" id="analyzeBtn" disabled>
          <div class="btn-content">
            <span class="btn-icon">🧠</span>
            <div class="btn-text-container">
              <span class="btn-text" id="analyzeText">Analizza con AI Ibrida</span>
              <span class="btn-subtitle">Google Vision + Claude AI + ML</span>
            </div>
          </div>
          <div class="btn-progress">
            <div class="progress-bar"></div>
          </div>
          <div class="loading-spinner" style="display: none;"></div>
        </button>
        
        <div class="analyze-help">
          <p id="analyzeHelpText">💡 <strong>Suggerimento:</strong> Per risultati migliori, scatta la foto in zone tipiche per il target selezionato</p>
        </div>
      </div>

      <!-- Results Section -->
      <div class="result-section" id="resultSection" style="display: none;">
        <div class="result-header">
          <h2>🧠 Risultati Rilevamento AI</h2>
          <div class="result-badge" id="resultBadge">Analisi Completata</div>
        </div>
        
        <div class="result-main">
          <div class="prediction-score">
            <div class="score-container">
              <div class="score-circle" id="scoreCircle">
                <span id="scoreValue">--</span>
                <span class="score-unit">%</span>
              </div>
              <div class="score-indicators">
                <div class="indicator low"></div>
                <div class="indicator medium"></div>
                <div class="indicator high"></div>
              </div>
            </div>
            <p class="score-label" id="scoreLabel">Probabilità di Trovare il Target</p>
          </div>
          
          <div class="prediction-details">
            <div id="aiPrediction">Analisi in corso...</div>
          </div>
        </div>
        
        <!-- Environmental Factors -->
        <div class="factors-section">
          <h4>🌱 Fattori Ambientali</h4>
          <div class="factors-grid">
            <div class="factor-item">
              <span class="factor-icon">🌡️</span>
              <span class="factor-label">Temperatura</span>
              <span class="factor-value" id="tempFactor">–</span>
            </div>
            <div class="factor-item">
              <span class="factor-icon">💧</span>
              <span class="factor-label">Umidità</span>
              <span class="factor-value" id="humidityFactor">–</span>
            </div>
            <div class="factor-item">
              <span class="factor-icon">🌿</span>
              <span class="factor-label">Vegetazione</span>
              <span class="factor-value" id="vegetationFactor">–</span>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="result-actions">
          <button class="action-btn secondary" id="newScanBtn">
            <span>🔄 Nuovo Rilevamento</span>
          </button>
          <a href="/dashboard.html" class="action-btn tertiary">
            <span>📊 Vedi Dashboard</span>
          </a>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-info">
          <p>Made with 👃 by Sniffer Team</p>
          <p class="footer-subtitle">Universal AI-powered detection platform</p>
        </div>
        <div class="footer-links">
          <a href="/dashboard.html">📊 Analytics</a>
          <a href="#" onclick="showInfo()">ℹ️ Info</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  
  <script>
    // Search target configurations
    const searchTargets = {
      funghi: {
        icon: '🍄',
        title: 'Modalità Funghi',
        description: 'Ricerca funghi commestibili in base a terreno, umidità e vegetazione',
        tips: 'Cerca in zone umide, vicino a querce e castagni, dopo piogge',
        actionTitle: '🍄 Caccia ai Funghi',
        actionDesc: 'Analizza il terreno e scopri se ci sono funghi commestibili nelle vicinanze',
        analyzeText: 'Rileva Funghi',
        uploadHint: 'Inquadra il sottobosco dove cerchi funghi',
        helpText: '💡 <strong>Suggerimento:</strong> Migliori risultati in zone umide con foglie decomposte',
        scoreLabel: 'Probabilità di Trovare Funghi'
      },
      tartufi: {
        icon: '🟤',
        title: 'Modalità Tartufi', 
        description: 'Ricerca tartufi pregiati analizzando suolo, radici e microclima',
        tips: 'Cerca vicino a querce, noccioli e tigli, in terreni calcarei',
        actionTitle: '🟤 Caccia al Tartufo',
        actionDesc: 'Trova tartufi pregiati con analisi avanzata del terreno',
        analyzeText: 'Rileva Tartufi',
        uploadHint: 'Inquadra il terreno vicino alle radici degli alberi',
        helpText: '💡 <strong>Suggerimento:</strong> I tartufi crescono vicino alle radici in terreni ben drenati',
        scoreLabel: 'Probabilità di Trovare Tartufi'
      },
      erbe: {
        icon: '🌿',
        title: 'Modalità Erbe',
        description: 'Riconoscimento erbe medicinali e piante officinali selvatiche',
        tips: 'Cerca in prati, radure e margini boschivi non inquinati',
        actionTitle: '🌿 Ricerca Erbe',
        actionDesc: 'Identifica erbe medicinali e piante officinali selvatiche',
        analyzeText: 'Identifica Erbe',
        uploadHint: 'Inquadra le piante che vuoi identificare',
        helpText: '💡 <strong>Suggerimento:</strong> Evita zone vicine a strade o aree inquinate',
        scoreLabel: 'Probabilità Erbe Medicinali'
      },
      custom: {
        icon: '⚙️',
        title: 'Modalità Personalizzata',
        description: 'Configura i sensori per rilevare target specifici',
        tips: 'Calibra la sonda olfattiva per il tuo obiettivo specifico',
        actionTitle: '⚙️ Rilevamento Custom',
        actionDesc: 'Usa sensori calibrati per trovare il tuo target specifico',
        analyzeText: 'Rileva Target',
        uploadHint: 'Inquadra l\'area dove cercare il target',
        helpText: '💡 <strong>Suggerimento:</strong> Assicurati che i sensori siano calibrati',
        scoreLabel: 'Probabilità Target Personalizzato'
      }
    };

    let currentTarget = 'funghi';

    // Update search mode
    function updateSearchMode() {
      const target = document.getElementById('searchTarget').value;
      currentTarget = target;
      const config = searchTargets[target];
      
      // Update hero visual
      document.getElementById('heroTargetIcon').textContent = config.icon;
      
      // Update mode info
      document.getElementById('modeIcon').textContent = config.icon;
      document.getElementById('modeTitle').textContent = config.title;
      document.getElementById('modeDescription').textContent = config.description;
      document.getElementById('modeTips').innerHTML = `<strong>💡 Suggerimenti:</strong> ${config.tips}`;
      
      // Update action card
      document.getElementById('actionTitle').textContent = config.actionTitle;
      document.getElementById('actionDescription').textContent = config.actionDesc;
      
      // Update upload section
      document.getElementById('uploadHint').textContent = config.uploadHint;
      
      // Update analyze button
      document.getElementById('analyzeText').textContent = config.analyzeText;
      document.getElementById('analyzeHelpText').innerHTML = config.helpText;
      
      // Update result labels
      document.getElementById('scoreLabel').textContent = config.scoreLabel;
      
      // Show/hide sensor section for custom mode
      const sensorSection = document.getElementById('sensorSection');
      if (target === 'custom') {
        sensorSection.style.display = 'block';
      } else {
        sensorSection.style.display = 'none';
      }
      
      console.log('Search mode updated to:', target);
    }

    // Enhanced UI functions
    function startQuickScan() {
      takePhoto();
      document.getElementById('uploadArea').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
    }
    
    function scrollToDetailedScan() {
      document.querySelector('.upload-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
    
    function takePhoto() {
      const input = document.getElementById('imageUpload');
      input.setAttribute('capture', 'environment');
      input.click();
    }
    
    function selectPhoto() {
      const input = document.getElementById('imageUpload');
      input.removeAttribute('capture');
      input.click();
    }
    
    function retakePhoto() {
      document.getElementById('removeImage').click();
      setTimeout(() => takePhoto(), 100);
    }
    
    function showInfo() {
      alert(`👃 Sniffer è una piattaforma universale di rilevamento che usa AI ibrida (Google Vision + Claude) e sensori intelligenti per trovare ${currentTarget} e altri target basandosi su fattori ambientali, visivi e olfattivi.`);
    }
    
    function calibrateSensor() {
      alert('🔬 Calibrazione sensore non ancora implementata. Funzionalità disponibile con hardware Phase 2.');
    }
    
    // Load hero stats
    async function loadHeroStats() {
      try {
        const response = await fetch('/api/dashboard?type=feedback');
        if (response.ok) {
          const data = await response.json();
          const records = data.records || [];
          
          // Filter by current target if needed
          const targetRecords = records.filter(r => 
            !r.fields?.Search_Target || r.fields?.Search_Target === currentTarget
          );
          
          document.getElementById('heroTotalScans').textContent = targetRecords.length || records.length;
          
          const accurate = targetRecords.filter(r => r.fields?.Accuracy === 100).length;
          const accuracy = targetRecords.length > 0 ? Math.round((accurate / targetRecords.length) * 100) : 0;
          document.getElementById('heroAccuracy').textContent = accuracy + '%';
          
          const found = targetRecords.filter(r => r.fields?.Found_Target === true).length;
          const success = targetRecords.length > 0 ? Math.round((found / targetRecords.length) * 100) : 0;
          document.getElementById('heroSuccess').textContent = success + '%';
        }
      } catch (error) {
        // Use mock data
        document.getElementById('heroTotalScans').textContent = '127';
        document.getElementById('heroAccuracy').textContent = '89%';
        document.getElementById('heroSuccess').textContent = '71%';
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateSearchMode(); // Set initial mode
      loadHeroStats();
    });
    
    // Get current search target (for script.js integration)
    window.getCurrentSearchTarget = function() {
      return currentTarget;
    };
  </script>
</body>
</html>