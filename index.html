<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‘ƒ Sniffer - Rilevatore Intelligente Universale</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header compatto -->
  <header class="header-compact">
    <div class="container">
      <div class="header-content">
        <div class="logo-compact">
          <span class="logo-icon">ğŸ‘ƒ</span>
          <h1>Sniffer</h1>
        </div>
        <nav class="nav">
          <a href="/dashboard.html" class="nav-link">
            <span class="nav-icon">ğŸ“Š</span>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Hero Section Compatto -->
  <div class="hero-compact">
    <div class="container">
      <div class="hero-grid">
        <!-- Left: Main Content -->
        <div class="hero-main">
          <h2 class="hero-title">Rilevatore Intelligente</h2>
          <p class="hero-subtitle">Trova tesori nascosti con AI, sensori e machine learning</p>
          
          <!-- Target Selector Inline -->
          <div class="target-selector-inline">
            <label for="searchTarget">ğŸ¯ Cosa cerchi?</label>
            <select id="searchTarget" onchange="updateSearchMode()">
              <option value="funghi">ğŸ„ Funghi</option>
              <option value="tartufi">ğŸŸ¤ Tartufi</option>
              <option value="erbe">ğŸŒ¿ Erbe Medicinali</option>
              <option value="custom">âš™ï¸ Personalizzato</option>
            </select>
          </div>
          
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="quick-btn primary" onclick="quickScanPhoto()">
              <span class="btn-icon">ğŸ“·</span>
              <span>Scan Rapido</span>
            </button>
            <button class="quick-btn secondary" onclick="scrollToAdvanced()">
              <span class="btn-icon">ğŸ”¬</span>
              <span>Avanzato</span>
            </button>
          </div>
        </div>

        <!-- Right: Stats + Sensor Widget -->
        <div class="hero-side">
          <!-- Stats Compatte -->
          <div class="stats-compact">
            <div class="stat-mini">
              <span class="stat-number" id="heroTotalScans">127</span>
              <span class="stat-text">Rilevamenti</span>
            </div>
            <div class="stat-mini">
              <span class="stat-number" id="heroAccuracy">89%</span>
              <span class="stat-text">Accuracy</span>
            </div>
            <div class="stat-mini">
              <span class="stat-number" id="heroSuccess">71%</span>
              <span class="stat-text">Successi</span>
            </div>
          </div>

          <!-- Sensor Widget Sempre Visibile -->
          <div class="sensor-widget" id="sensorWidget">
            <div class="sensor-header">
              <span class="sensor-icon" id="sensorIcon">ğŸ“¡</span>
              <div class="sensor-info">
                <span class="sensor-title">Sonda Hardware</span>
                <span class="sensor-status" id="sensorStatusText">Non Connessa</span>
              </div>
              <div class="sensor-indicator" id="sensorIndicator"></div>
            </div>
            
            <div class="sensor-actions" id="sensorActions">
              <button class="sensor-btn" id="connectSensorBtn" onclick="connectSensor()">
                Connetti
              </button>
            </div>
            
            <!-- Sensor Controls (quando connesso) -->
            <div class="sensor-controls" id="sensorControls" style="display: none;">
              <div class="sensor-reading">
                <span class="reading-label">Segnale:</span>
                <span class="reading-value" id="sensorReading">-- ppm</span>
              </div>
              <button class="calibrate-btn" onclick="calibrateSensor()">
                ğŸ¯ Calibra per <span id="calibrateTarget">Funghi</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App - Layout Migliorato -->
  <div class="app-container">
    <div class="container">
      
      <!-- Mode Info Compatta -->
      <div class="mode-banner" id="modeBanner">
        <div class="mode-content">
          <span class="mode-icon" id="modeIcon">ğŸ„</span>
          <div class="mode-text">
            <strong id="modeTitle">ModalitÃ  Funghi</strong>
            <span id="modeTips">Cerca in zone umide, vicino a querce e castagni</span>
          </div>
        </div>
      </div>

      <!-- Workflow Cards -->
      <div class="workflow-section">
        <h3>ğŸ¯ Scegli il Metodo di Rilevamento</h3>
        
        <div class="workflow-grid">
          <!-- AI Vision Method -->
          <div class="workflow-card ai-method" id="aiMethodCard">
            <div class="method-header">
              <span class="method-icon">ğŸ‘ï¸</span>
              <h4>Analisi AI Visiva</h4>
              <span class="method-badge">Sempre Disponibile</span>
            </div>
            <p class="method-description">Usa foto del terreno + intelligenza artificiale ibrida (Google Vision + Claude AI)</p>
            
            <!-- Photo Upload Compatto -->
            <div class="photo-upload-compact" id="photoUploadArea">
              <input type="file" id="imageUpload" accept="image/*" capture="environment" hidden>
              <div class="upload-zone" onclick="selectPhoto()">
                <div class="upload-icon">ğŸ“·</div>
                <span class="upload-text">Aggiungi Foto</span>
              </div>
              <div class="photo-preview" id="photoPreview" style="display: none;">
                <img id="previewImage" alt="Preview">
                <button class="remove-photo" onclick="removePhoto()">âœ•</button>
              </div>
            </div>
            
            <button class="method-btn ai-btn" id="analyzeAIBtn" onclick="analyzeWithAI()">
              <span>ğŸ§  Analizza con AI</span>
            </button>
          </div>

          <!-- Hardware Method -->
          <div class="workflow-card hardware-method" id="hardwareMethodCard">
            <div class="method-header">
              <span class="method-icon">ğŸ”¬</span>
              <h4>Rilevamento Hardware</h4>
              <span class="method-badge hardware-status" id="hardwareBadge">Sonda Richiesta</span>
            </div>
            <p class="method-description">Usa sensori olfattivi calibrati per rilevamento chimico diretto</p>
            
            <!-- Hardware Controls -->
            <div class="hardware-controls" id="hardwareControls">
              <div class="sensor-reading-display">
                <div class="reading-gauge">
                  <div class="gauge-fill" id="gaugeFill"></div>
                  <span class="gauge-value" id="gaugeValue">0</span>
                </div>
                <span class="reading-unit">ppm</span>
              </div>
              
              <div class="sensor-calibration" id="sensorCalibrationPanel" style="display: none;">
                <p>ğŸ¯ Calibra sensore per <strong id="calibrationTarget">funghi</strong></p>
                <div class="calibration-steps">
                  <button class="cal-btn" onclick="startCalibration()">Inizia Calibrazione</button>
                  <span class="cal-status" id="calibrationStatus">Pronto</span>
                </div>
              </div>
            </div>
            
            <button class="method-btn hardware-btn" id="analyzeHardwareBtn" onclick="analyzeWithHardware()" disabled>
              <span>ğŸ”¬ Rileva con Sensori</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Environmental Status Compatto -->
      <div class="env-status-compact">
        <div class="env-grid">
          <div class="env-item">
            <span class="env-icon">ğŸ“</span>
            <span class="env-label">Posizione</span>
            <span class="env-value" id="location">Rilevamento...</span>
          </div>
          <div class="env-item">
            <span class="env-icon">ğŸ”ï¸</span>
            <span class="env-label">Altitudine</span>
            <span class="env-value" id="elevation">â€“</span>
          </div>
          <div class="env-item">
            <span class="env-icon">ğŸŒ¦ï¸</span>
            <span class="env-label">Meteo</span>
            <span class="env-value" id="weather">â€“</span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="result-section" id="resultSection" style="display: none;">
        <div class="result-header">
          <h2>ğŸ§  Risultati Rilevamento</h2>
          <span class="result-method" id="resultMethod">AI Vision</span>
        </div>
        
        <div class="result-main">
          <div class="score-display">
            <div class="score-circle" id="scoreCircle">
              <span id="scoreValue">--</span>
              <span class="score-unit">%</span>
            </div>
            <p class="score-label" id="scoreLabel">ProbabilitÃ  Target</p>
          </div>
          
          <div class="result-details">
            <div id="aiPrediction">Analisi in corso...</div>
          </div>
        </div>
        
        <!-- Environmental Factors Compatto -->
        <div class="factors-compact">
          <div class="factor-item">
            <span class="factor-icon">ğŸŒ¡ï¸</span>
            <span class="factor-value" id="tempFactor">â€“</span>
          </div>
          <div class="factor-item">
            <span class="factor-icon">ğŸ’§</span>
            <span class="factor-value" id="humidityFactor">â€“</span>
          </div>
          <div class="factor-item">
            <span class="factor-icon">ğŸŒ¿</span>
            <span class="factor-value" id="vegetationFactor">â€“</span>
          </div>
        </div>
        
        <!-- Result Actions -->
        <div class="result-actions">
          <button class="result-btn secondary" onclick="newScan()">
            ğŸ”„ Nuovo Scan
          </button>
          <a href="/dashboard.html" class="result-btn primary">
            ğŸ“Š Dashboard
          </a>
        </div>
      </div>

    </div>
  </div>

  <!-- Footer Compatto -->
  <footer class="footer-compact">
    <div class="container">
      <div class="footer-content">
        <span>Made with ğŸ‘ƒ by Sniffer Team</span>
        <a href="#" onclick="showInfo()">â„¹ï¸ Info</a>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  
  <script>
    // Search target configurations
    const searchTargets = {
      funghi: {
        icon: 'ğŸ„',
        title: 'ModalitÃ  Funghi',
        tips: 'Cerca in zone umide, vicino a querce e castagni'
      },
      tartufi: {
        icon: 'ğŸŸ¤',
        title: 'ModalitÃ  Tartufi', 
        tips: 'Cerca vicino a querce, noccioli e tigli, in terreni calcarei'
      },
      erbe: {
        icon: 'ğŸŒ¿',
        title: 'ModalitÃ  Erbe',
        tips: 'Cerca in prati, radure e margini boschivi non inquinati'
      },
      custom: {
        icon: 'âš™ï¸',
        title: 'ModalitÃ  Personalizzata',
        tips: 'Usa sensori calibrati per il tuo target specifico'
      }
    };

    let currentTarget = 'funghi';
    let sensorConnected = false;
    let selectedImage = null;

    // Update search mode
    function updateSearchMode() {
      const target = document.getElementById('searchTarget').value;
      currentTarget = target;
      const config = searchTargets[target];
      
      // Update mode banner
      document.getElementById('modeIcon').textContent = config.icon;
      document.getElementById('modeTitle').textContent = config.title;
      document.getElementById('modeTips').textContent = config.tips;
      
      // Update calibration target
      document.getElementById('calibrateTarget').textContent = target;
      document.getElementById('calibrationTarget').textContent = target;
      
      // Show/hide hardware method based on target
      const hardwareCard = document.getElementById('hardwareMethodCard');
      if (target === 'custom') {
        hardwareCard.style.display = 'block';
        document.getElementById('sensorCalibrationPanel').style.display = 'block';
      } else {
        hardwareCard.style.display = 'none';
        document.getElementById('sensorCalibrationPanel').style.display = 'none';
      }
    }

    // Quick scan functions
    function quickScanPhoto() {
      selectPhoto();
      setTimeout(() => {
        if (selectedImage) {
          analyzeWithAI();
        }
      }, 100);
    }

    function scrollToAdvanced() {
      document.querySelector('.workflow-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }

    // Photo handling
    function selectPhoto() {
      document.getElementById('imageUpload').click();
    }

    function removePhoto() {
      selectedImage = null;
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoUploadArea').querySelector('.upload-zone').style.display = 'block';
      updateAnalyzeButton();
    }

    function updateAnalyzeButton() {
      const btn = document.getElementById('analyzeAIBtn');
      if (selectedImage && window.currentLocation) {
        btn.disabled = false;
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.6';
      }
    }

    // Sensor functions
    function connectSensor() {
      // Simulate sensor connection
      sensorConnected = true;
      document.getElementById('sensorStatusText').textContent = 'Connessa';
      document.getElementById('sensorIndicator').className = 'sensor-indicator connected';
      document.getElementById('hardwareBadge').textContent = 'Connessa';
      document.getElementById('hardwareBadge').className = 'method-badge connected';
      document.getElementById('sensorControls').style.display = 'block';
      document.getElementById('sensorActions').style.display = 'none';
      document.getElementById('analyzeHardwareBtn').disabled = false;
      
      // Start mock sensor readings
      startMockSensorReadings();
    }

    function startMockSensorReadings() {
      setInterval(() => {
        if (sensorConnected) {
          const reading = Math.round(Math.random() * 100);
          document.getElementById('sensorReading').textContent = reading + ' ppm';
          document.getElementById('gaugeValue').textContent = reading;
          document.getElementById('gaugeFill').style.width = Math.min(reading, 100) + '%';
        }
      }, 2000);
    }

    function calibrateSensor() {
      alert(`ğŸ”¬ Calibrazione per ${currentTarget} avviata. Posiziona la sonda nel campione di riferimento.`);
      document.getElementById('calibrationStatus').textContent = 'Calibrando...';
      setTimeout(() => {
        document.getElementById('calibrationStatus').textContent = 'Calibrato âœ…';
      }, 3000);
    }

    function startCalibration() {
      calibrateSensor();
    }

    // Analysis functions
    function analyzeWithAI() {
      if (!selectedImage || !window.currentLocation) {
        alert('Assicurati di avere foto e posizione');
        return;
      }
      
      document.getElementById('resultMethod').textContent = 'AI Vision';
      // Call existing analysis function from script.js
      if (window.performAnalysis) {
        window.performAnalysis();
      }
    }

    function analyzeWithHardware() {
      if (!sensorConnected) {
        alert('Connetti prima la sonda hardware');
        return;
      }
      
      document.getElementById('resultMethod').textContent = 'Hardware Sensing';
      // Simulate hardware analysis
      simulateHardwareAnalysis();
    }

    function simulateHardwareAnalysis() {
      document.getElementById('resultSection').style.display = 'block';
      
      // Mock hardware results
      const probability = Math.round(Math.random() * 100);
      document.getElementById('scoreValue').textContent = probability;
      document.getElementById('scoreLabel').textContent = `Concentrazione ${currentTarget}`;
      
      document.getElementById('aiPrediction').innerHTML = `
        <h4>ğŸ”¬ Analisi Sensori Hardware</h4>
        <p>Rilevata concentrazione significativa di composti organici volatili tipici di ${currentTarget}.</p>
        <p><strong>Lettura sensore:</strong> ${document.getElementById('sensorReading').textContent}</p>
      `;
      
      document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
    }

    function newScan() {
      document.getElementById('resultSection').style.display = 'none';
      removePhoto();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showInfo() {
      alert('ğŸ‘ƒ Sniffer Ã¨ una piattaforma universale di rilevamento che combina AI vision e sensori hardware per trovare tesori nascosti in natura.');
    }

    // Image upload handler
    document.getElementById('imageUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedImage = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImage').src = e.target.result;
          document.getElementById('photoPreview').style.display = 'block';
          document.getElementById('photoUploadArea').querySelector('.upload-zone').style.display = 'none';
          updateAnalyzeButton();
        };
        reader.readAsDataURL(file);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateSearchMode();
      
      // Load stats
      if (window.loadHeroStats) {
        window.loadHeroStats();
      }
    });
  </script>
</body>
</html>